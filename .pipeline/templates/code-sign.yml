steps:
- task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@3
  displayName: 'ESRP CodeSigning for Windows'
  condition: eq(variables['platform'], 'windows')
  inputs:
    ConnectedServiceName: 'Code Signing'
    FolderPath: '$(Build.SourcesDirectory)\dist\pgsqltoolsservice'
    Pattern: '*.exe, *.dll'
    signConfigType: inlineSignParams
    inlineOperation: |
     [
        {
            "keyCode": "CP-230012",
            "operationSetCode": "SigntoolSign",
            "parameters": [
                {
                    "parameterName": "OpusName",
                    "parameterValue": "PgToolsService"
                },
                {
                    "parameterName": "OpusInfo",
                    "parameterValue": "https://github.com/Microsoft/pgtoolsservice"
                },
                {
                    "parameterName": "PageHash",
                    "parameterValue": "/NPH"
                },
                {
                    "parameterName": "FileDigest",
                    "parameterValue": "/fd sha256"
                },
                {
                    "parameterName": "TimeStamp",
                    "parameterValue": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                }
            ],
            "toolName": "signtool.exe",
            "toolVersion": "6.2.9304.0"
        },
        {
            "keyCode": "CP-230012",
            "operationSetCode": "SigntoolVerify",
            "parameters": [
                {
                    "parameterName": "VerifyAll",
                    "parameterValue": "/all"
                }
            ],
            "toolName": "signtool.exe",
            "toolVersion": "6.2.9304.0"
        }
     ]
  enabled: true
- task: CmdLine@2
  displayName: 'Pre-sign steps for non-windows platform'
  condition: ne(variables['platform'], 'windows')
  inputs:
    script: |
      cp $(Build.SourcesDirectory)/dist/pgsqltoolsservice/ossdbtoolsservice_main $(Build.SourcesDirectory)/dist
      mv $(Build.SourcesDirectory)/dist/pgsqltoolsservice/ossdbtoolsservice_main $(Build.SourcesDirectory)/dist/pgsqltoolsservice/ossdbtoolsservice_main_sig
- task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@3
  displayName: 'ESRP CodeSigning for Mac'
  condition: eq(variables['platform'], 'mac')
  inputs:
    ConnectedServiceName: 'Code Signing'
    FolderPath: '$(Build.SourcesDirectory)\dist\pgsqltoolsservice'
    Pattern: 'ossdbtoolsservice_main*'
    useMinimatch: true
    signConfigType: inlineSignParams
    inlineOperation: |
      [
        {
          "KeyCode" : "CP-450779-Pgp",
          "OperationCode" : "LinuxSign",
          "Parameters" : {},
          "ToolName" : "sign",
          "ToolVersion" : "1.0"
        }
      ]
    SessionTimeout: '60'
    MaxConcurrency: '50'
    MaxRetryAttempts: '5'
- task: CmdLine@2
  displayName: 'Post-sign steps for non-windows platforms'
  condition: ne(variables['platform'], 'windows')
  inputs:
    script: |
      mv $(Build.SourcesDirectory)/dist/ossdbtoolsservice_main $(Build.SourcesDirectory)/dist/pgsqltoolsservice
